<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Куда пойти — Москва глазами Артёма</title>

  {% load static %}

  <link rel="shortcut icon" href="{% static 'app/images/favicon.ico' %}" type="image/png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
  <link rel="stylesheet" href="{% static 'app/css/leaflet-sidebar.css' %}"/>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/@ansur/leaflet-pulse-icon@0.1.1/dist/L.Icon.Pulse.css">

  <style>
    body {
      padding: 0;
      margin: 0;
    }

    html, body, #map {
      height: 100%;
    }

    .place-description img {
      max-width: 100%;
    }

    .sidebar-content {
      padding: 14px 20px;
      height: 100%;
    }
    .select-place-prompt{
      color: red;
      width: 100px;
    }
  </style>

  <script id="app-template" type="text/template">
    <div v-bind:class="{'sidebar-content': 1, 'bg-white': selectedPlace, 'bg-secondary': !selectedPlace}">
      <div v-if="promptVisible" class="d-flex flex-column justify-content-center align-items-center" style="height: 100%;">
        <img class="d-block select-place-prompt mb-4" src="{% static 'app/images/hand-pointer-regular.svg' %}" alt="Select place">
        <h4>Выберите место на карте</h4>
      </div>

      <div class="align-items-center justify-content-center d-flex" v-if="loading" style="height: 100%;">
        <div class="spinner-grow text-light" style="width: 3rem; height: 3rem;" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <div class="place-description" v-if="selectedPlace">

        <img v-if="mainPhotoSrc" v-bind:src="mainPhotoSrc" class="d-block shadow mb-3 rounded" v-bind:alt="selectedPlace.title">

        <h5 class="mb-3">{{ selectedPlace.title }}</h5>

        <p>{{ selectedPlace.short_description }}</p>

        <div id="place-photos" class="carousel slide mb-3 shadow" data-ride="carousel" data-interval="5000">
          <ol class="carousel-indicators">
            <template v-for="(img, index) in carouselImgs" :key="img">
              <li v-on:click="handlePhotosClick(index)" v-bind:class="{active: index==0}"></li>
            </template>
          </ol>
          <div class="carousel-inner">
            <template v-for="(img, index) in carouselImgs" :key="img">
              <div v-bind:class="{'carousel-item bg-light': 1, active: index==0}">
                <img v-bind:src="img" class="d-block w-100" v-bind:alt="selectedPlace.title">
              </div>
            </template>
          </div>
          <template v-if="carouselImgs.length">
            <a class="carousel-control-prev" v-on:click="handlePhotosClick('prev')" role="button">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" v-on:click="handlePhotosClick('next')" role="button">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </template>
        </div>

        <div v-html="selectedPlace.long_description"></div>
      </div>
    </div>
  </script>

</head>
<body>
  <div id="sidebar">
    <div id="sidebar-app"></div>
  </div>

  <div id="map"></div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.10.1/leaflet-providers.min.js" integrity="sha256-EV/ywRtxUOBICwOsLtPpYEONoBF6g+ShAcLX1Ts48GA=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-control-custom@1.0.0/Leaflet.Control.Custom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/loglevel/1.6.8/loglevel.min.js" integrity="sha256-O/iFn3B3kEV/q5PPVW8TVpRhoywaK7NN4UjdnBO9DXo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js" integrity="sha256-ngFW3UnAN0Tnm76mDuu7uUtYEcG3G5H1+zioJw3t+68=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@ansur/leaflet-pulse-icon@0.1.1/dist/L.Icon.Pulse.js"></script>

  <script src="{% static 'app/js/leaflet-sidebar.js' %}"></script>

  <script>
    /**
     * Инициализация кастомного логгера для отладки приложения
     * Предоставляет методы для логирования с разными уровнями важности
     */
    var log = {
        /**
         * Логирование отладочной информации
         * @param {string} msg - Текст сообщения
         * @param {any} data - Данные для логирования
         */
        debug: function(msg, data) { console.log(msg, data); },
        
        /**
         * Логирование ошибок
         * @param {string} msg - Текст сообщения об ошибке
         */
        error: function(msg) { console.error(msg); },
        
        /**
         * Получение текущего уровня логирования
         * @returns {number} Уровень логирования
         */
        getLevel: function() { return 1; },
        
        /**
         * Установка уровня логирования
         * @param {string} level - Уровень логирования ('debug', 'warn', etc.)
         */
        setLevel: function(level) { console.log('Log level set to:', level); }
    };


    // Инициализация карты Leaflet с центром в координатах Москвы
    var map = L.map('map');
    // Установка начального вида карты: [широта, долгота], уровень масштабирования
    map.setView([55.753989, 37.623191], 11);

    // Добавление слоя тайлов OpenStreetMap на карту
    L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(map);

    /**
     * Инициализация боковой панели для отображения информации о местах
     * @type {L.Control.Sidebar}
     */
    var sidebar = L.control.sidebar('sidebar', {
        closeButton: true,    // Отображение кнопки закрытия
        position: 'right'     // Позиция панели - справа
    });
    map.addControl(sidebar);


    /**
     * Создание кастомного контрола для отладки (должен быть скрыт в продакшене)
     * FIXME: следует скрыть в продакшен-режиме
     */
    L.control.custom({
        position: 'bottomleft',  // Позиция в левом нижнем углу карты
        content: `
            <label>
                <input name="debug" type="checkbox" ${log.getLevel()<=1 && 'checked'}/>
                Отладка
            </label>`,
        style: {
            padding: '10px',
            background: 'rgba(255, 255, 255, 0.7)',  // Полупрозрачный белый фон
        },
        events: {
            /**
             * Обработчик клика по чекбоксу отладки
             * @param {Event} event - Событие клика
             */
            click: event => {
                if (event.target.name == 'debug'){
                    // Установка уровня логирования в зависимости от состояния чекбокса
                    let level = event.target.checked ? 'debug' : 'warn';
                    log.setLevel(level);
                    console.log(`Set log level: ${level}`)
                }
            },
        }
    }).addTo(map);

    /**
     * Асинхронная функция для загрузки GeoJSON данных мест из API
     * @async
     * @returns {Promise<Object>} Promise с GeoJSON объектом мест
     */
    async function loadPlacesGeoJSON(){
        try {
            // Выполнение GET запроса к API для получения данных мест
            const response = await fetch('/places.geojson');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // Парсинг JSON ответа
            const geojson = await response.json();
            log.debug('Loaded GeoJSON from API', geojson);
            return geojson;
        } catch (error) {
            console.error('Error loading places GeoJSON:', error);
            // Возвращаем пустой GeoJSON в случае ошибки
            return {
                type: "FeatureCollection",
                features: []
            };
        }
    }

    /**
     * Асинхронная функция инициализации карты с загрузкой данных мест
     * @async
     */
    async function initMapWithPlaces(){
        // Загрузка данных мест из API
        const places = await loadPlacesGeoJSON();
        
        /**
         * Добавление GeoJSON слоя с местами на карту
         * с кастомными маркерами и обработчиками событий
         */
        L.geoJSON(places, {
            /**
             * Функция создания кастомных маркеров для точек на карте
             * @param {Object} geoJsonPoint - GeoJSON объект точки
             * @param {L.LatLng} latlng - Координаты точки
             * @returns {L.Marker} Созданный маркер
             */
            pointToLayer: function(geoJsonPoint, latlng) {
                // Проверка типа геометрии (должна быть Point)
                if (geoJsonPoint.geometry.type != "Point"){
                    return;
                }

                // Определение цвета маркера (красный по умолчанию)
                let color = geoJsonPoint.properties.color || 'red';

                // Создание пульсирующей иконки для маркера
                var pulsingIcon = L.icon.pulse({
                    iconSize: [12, 12],    // Размер иконки
                    color: color,          // Цвет пульсации
                    fillColor: color,      // Цвет заливки
                    heartbeat: 2.5,        // Скорость пульсации
                });

                // Создание маркера с пульсирующей иконкой
                let marker = L.marker(latlng, {
                    icon: pulsingIcon,
                    riseOnHover: true,     // Поднятие маркера при наведении
                });

                // Привязка всплывающей подсказки с названием места
                marker.bindTooltip(geoJsonPoint.properties.title);
                
                // Привязка попапа с названием места
                marker.bindPopup(function (layer) {
                    return geoJsonPoint.properties.title;
                });

                /**
                 * Обработчик клика по маркеру
                 * @param {Event} event - Событие клика
                 */
                marker.on('click', function(event){
                    log.debug('Feature selected', geoJsonPoint);
                    // Показать боковую панель
                    sidebar.show();
                    // Загрузить информацию о выбранном месте
                    loadPlaceInfo(geoJsonPoint.properties.placeId, geoJsonPoint.properties.detailsUrl);
                });
                return marker;
            }
        }).addTo(map);
    }


    /**
     * Vue.js приложение для управления боковой панелью
     * @type {Vue}
     */
    var sidebarApp = new Vue({
        el: '#sidebar-app',  // Элемент DOM для монтирования приложения
        template: document.getElementById('app-template').innerHTML,  // Шаблон из HTML
        data: {
            loadingPlaceId: null,    // ID загружаемого места (null если не загружается)
            selectedPlace: null      // Данные выбранного места
        },
        computed: {
            /**
             * Определяет, нужно ли показывать приглашение выбрать место
             * @returns {boolean}
             */
            promptVisible: function () {
                return !this.loading && !this.selectedPlace;
            },
            
            /**
             * Определяет, выполняется ли загрузка данных
             * @returns {boolean}
             */
            loading: function () {
                return this.loadingPlaceId !== null;
            },
            
            /**
             * Возвращает URL главного изображения места
             * @returns {string|null} URL изображения или null
             */
            mainPhotoSrc: function () {
                if (!this.selectedPlace || !this.selectedPlace.imgs || !this.selectedPlace.imgs.length){
                    return null;
                }
                return this.selectedPlace.imgs[0];
            },
            
            /**
             * Возвращает массив изображений для карусели (все кроме первого)
             * @returns {Array} Массив URL изображений
             */
            carouselImgs: function () {
                if (!this.selectedPlace || !this.selectedPlace.imgs || !this.selectedPlace.imgs.length){
                    return [];
                }
                return this.selectedPlace.imgs.slice(1);
            },
        },
        /**
         * Хук жизненного цикла Vue - вызывается после обновления DOM
         */
        updated: function () {
            this.$nextTick(function () {
                // Инициализация карусели изображений после обновления DOM
                if ($('#place-photos').length) {
                    $('#place-photos').carousel();
                }
            });
        },
        methods: {
            /**
             * Обработчик клика по элементам управления каруселью
             * @param {string|number} slideId - ID слайда или направление ('prev'/'next')
             */
            handlePhotosClick: function(slideId) {
                if ($('#place-photos').length) {
                    $('#place-photos').carousel(slideId);
                }
            }
        },
    });

    /**
     * Обработчик клика по карте (сбрасывает выбранное место)
     */
    map.on('click', function () {
        sidebarApp.selectedPlace = null;
        sidebarApp.loadingPlaceId = null;
    });


    /**
     * Асинхронная функция загрузки детальной информации о месте
     * @async
     * @param {string} placeId - ID места
     * @param {string} detailsUrl - URL для загрузки детальной информации
     */
    async function loadPlaceInfo(placeId, detailsUrl){
        // Сброс предыдущих данных
        sidebarApp.selectedPlace = null;
        sidebarApp.loadingPlaceId = placeId;

        try {
            // Запрос детальной информации о месте
            let response = await fetch(detailsUrl);

            if (!response.ok){
                console.error('Failed to load place info:', response.status);
                return;
            }

            // Парсинг JSON ответа
            let data = await response.json();

            // Проверка, не был ли запрос отменен пользователем
            if (sidebarApp.loadingPlaceId != placeId){
                return;
            }

            // Обновление данных выбранного места
            sidebarApp.selectedPlace = {
                title: data.title,
                placeId: placeId,
                imgs: data.imgs || [],
                short_description: data.description_short,
                long_description: data.description_long,
            };
        } catch (error) {
            console.error('Error loading place info:', error);
        } finally {
            // Сброс флага загрузки после завершения
            if (sidebarApp.loadingPlaceId == placeId){
                sidebarApp.loadingPlaceId = null;
            }
        }
    }


    // Запуск инициализации карты с данными
    initMapWithPlaces();
  </script>
</body>
</html>